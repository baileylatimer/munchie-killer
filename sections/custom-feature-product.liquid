{% liquid
  assign product = section.settings.product
  if request.visual_preview_mode and product == blank
    assign product = collections.all.products.first
  endif

  assign variant = product.selected_or_first_available_variant
  assign inventory_quantity = variant.inventory_quantity
  assign inventory_policy = variant.inventory_policy

  if variant.inventory_management == 'shopify'
    assign inventory_managed = true
  endif

  if variant.quantity_rule.min > variant.inventory_quantity and inventory_managed and inventory_policy == 'deny'
    assign quantity_rule_soldout = true
  endif

  if inventory_managed
    if inventory_quantity <= 0 and inventory_policy == 'deny' or quantity_rule_soldout
      assign can_add_to_cart = false
      assign add_to_cart_text = 'products.product.sold_out' | t
    else
      assign can_add_to_cart = true
      assign add_to_cart_text = 'products.product.add_to_cart' | t
    endif
  else
    if product.selected_or_first_available_variant != null
      assign can_add_to_cart = true
      assign add_to_cart_text = 'products.product.add_to_cart' | t
    else
      assign can_add_to_cart = false
      assign add_to_cart_text = 'products.product.unavailable' | t
    endif
  endif
%}

<div class="custom-feature-product tw-relative tw-w-full tw-overflow-hidden br" style="background-color: var(--color-contrast-lower); height: 937px;">
  {% if product != blank %}
    <script type="application/json" data-variants-json>
      [
        {% for v in product.variants %}
          {
            "id": {{ v.id }},
            "available": {{ v.available | json }},
            "options": [
              {% for o in v.options %}{{ o | json }}{% unless forloop.last %},{% endunless %}{% endfor %}
            ]
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    </script>
  {% endif %}
  <div class="tw-max-w-7xl tw-mx-auto tw-px-4 md:tw-px-8 tw-h-full tw-flex tw-flex-col tw-justify-between">
    
    <!-- Content Section -->
    <div class="tw-pt-16 tw-pb-8 tw-text-center tw-max-w-4xl tw-mx-auto">
      
      <!-- H2 Title -->
      {% if section.settings.heading != blank %}
        <h2 class="tw-text-3xl md:tw-text-4xl lg:tw-text-5xl tw-font-bold tw-mb-4" style="color: var(--color-contrast-higher);">
          {{ section.settings.heading }}
        </h2>
      {% endif %}

      <!-- Paragraph Description -->
      {% if section.settings.description != blank %}
        <p class="tw-text-base md:tw-text-lg tw-leading-relaxed tw-mb-4 tw-max-w-2xl tw-mx-auto" style="color: var(--color-contrast-higher);">
          {{ section.settings.description }}
        </p>
      {% endif %}

      <!-- H3 Price -->
      {% if product != blank %}
        <h3 class="tw-text-2xl md:tw-text-3xl tw-font-bold tw-mb-8" style="color: var(--color-contrast-higher);">
          {% if section.settings.show_subscription_option and section.settings.subscription_price != blank %}
            {{ section.settings.subscription_price }}
          {% else %}
            {{ product.price | money_without_trailing_zeros }}
          {% endif %}
        </h3>
      {% endif %}

      <!-- GPT's Guaranteed Shopify Form -->
      {% assign product_form_id = 'CustomFeatureProduct-Form-' | append: section.id %}

      {% if product != blank %}
        {%- form 'product', product, id: product_form_id, class: 'custom-feature-product__form' -%}
          {%- liquid
            assign current_variant = product.selected_or_first_available_variant
          -%}


          <input type="hidden" name="id" value="{{ current_variant.id }}">

          <input type="hidden" name="quantity" value="1">

          <button
            type="submit"
            class="custom-button"
            {% unless can_add_to_cart %}disabled{% endunless %}
          >
            {% if section.settings.button_text != blank %}
              {{ section.settings.button_text }}
            {% else %}
              {{ add_to_cart_text }}
            {% endif %}
          </button>
        {%- endform -%}
      {% else %}
        <button type="button" class="custom-button" disabled>
          Select a Product
        </button>
      {% endif %}

    </div>

    <!-- Product Image Section -->
    <div class="tw-relative tw-flex tw-justify-center tw-items-end tw-h-full">
      
      <!-- Oversized Radial Gradient -->
      <div 
        class="tw-absolute tw-inset-x-0 tw-bottom-0 tw-pointer-events-none"
        style="
          width: 120vw; 
          height: 120vw; 
          left: 50%; 
          transform: translateX(-50%) translateY(50%);
          background: radial-gradient(50% 50% at 50% 50%, #C8AB69 0%, rgba(200, 171, 105, 0.00) 100%);
          z-index: 1;
        "
      ></div>

      <!-- Product Image -->
      {% if section.settings.product_image != blank %}
        <div class="tw-relative tw-z-10 product-image-feature">
          {{ section.settings.product_image | image_url: width: 800 | image_tag: 
             class: 'tw-h-full tw-w-auto tw-object-contain', 
             loading: 'lazy',
             alt: section.settings.heading }}
        </div>
      {% else %}
        <!-- Placeholder -->
        <div class="tw-relative tw-z-10 tw-flex tw-items-center tw-justify-center tw-bg-gray-200 tw-rounded-lg" style="height: 545px; width: 400px;">
          <div class="tw-text-center tw-text-gray-500">
            <svg class="tw-w-16 tw-h-16 tw-mx-auto tw-mb-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
            </svg>
            <p class="tw-text-sm">Upload Product Image</p>
          </div>
        </div>
      {% endif %}

    </div>

  </div>
</div>

{{ 'custom-feature-product.js' | asset_url | script_tag }}

{% schema %}
{
  "name": "Custom Feature Product",
  "tag": "section",
  "class": "section  tw-pb-8",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "One pouch. 30 days of focus."
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "One pouch. 30 days of focus. Choose your flavor â€” or subscribe and save."
    },
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "checkbox",
      "id": "show_subscription_option",
      "label": "Show subscription pricing",
      "default": true
    },
    {
      "type": "text",
      "id": "subscription_price",
      "label": "Subscription price text",
      "default": "$45/mo",
      "info": "Display text for subscription option (e.g. '$45/mo')"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "ORDER NOW"
    },
    {
      "type": "image_picker",
      "id": "product_image",
      "label": "Product Image (PNG)"
    }
  ],
  "presets": [
    {
      "name": "Custom Feature Product"
    }
  ]
}
{% endschema %}
